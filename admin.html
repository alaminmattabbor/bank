<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Mattabbor Islamic Insurance</title>
    <link rel="stylesheet" href="admin.css">
    <link rel="htmlsheet" href="login.html">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <div class="admin-title">Mattabbor Islamic Insurance</div>
            <div class="admin-info">
                <div class="bell-icon" onclick="toggleNotifications()">
                    ðŸ””
                    <span class="notification-badge" id="notificationCount">0</span>
                </div>
                <div>Admin: <strong id="adminName">Administrator</strong></div>
                <button onclick="logout()" style="padding: 8px 16px; background: white; color: #667eea; border: none; border-radius: 5px; cursor: pointer;">Logout</button>
            </div>
        </div>

        <div class="admin-stats">
            <div class="stat-card">
                <div class="stat-number" id="totalApplications">0</div>
                <div class="stat-label">Total Applications</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingApplications">0</div>
                <div class="stat-label">Pending Review</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="approvedApplications">0</div>
                <div class="stat-label">Approved</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="rejectedApplications">0</div>
                <div class="stat-label">Rejected</div>
            </div>
        </div>

        <div class="applications-section">
            <h2 class="section-title">Application Management</h2>
            
            <div class="filter-controls">
                <select id="typeFilter">
                    <option value="all">All Types</option>
                    <option value="islamic-loan">Islamic Loan</option>
                    <option value="loan">Regular Loan</option>
                    <option value="insurance">Insurance</option>
                </select>
                <select id="statusFilter">
                    <option value="all">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="reviewing">Reviewing</option>
                    <option value="approved">Approved</option>
                    <option value="rejected">Rejected</option>
                </select>
                <input type="date" id="dateFilter" placeholder="Filter by date">
                <input type="text" id="searchFilter" placeholder="Search by name or ID...">
                <button onclick="applyFilters()">Apply Filters</button>
                <button onclick="exportData()">Export CSV</button>
            </div>

            <table class="applications-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Type</th>
                        <th>Applicant Name</th>
                        <th>Phone</th>
                        <th>Amount</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="applicationsTableBody">
                    <!-- Applications will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Application Details Modal -->
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Application Details</h3>
                <span class="close-modal" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalBody" class="application-details">
                <!-- Details will be loaded here -->
            </div>
            <div class="modal-actions">
                <button class="modal-btn btn-approve" onclick="updateStatus('approved')">Approve</button>
                <button class="modal-btn btn-review" onclick="updateStatus('reviewing')">Mark as Reviewing</button>
                <button class="modal-btn btn-reject" onclick="updateStatus('rejected')">Reject</button>
            </div>
        </div>
    </div>

    <!-- Notification Panel -->
    <div id="notificationPanel" class="notification-panel">
        <div class="notification-header">
            <h3>Notifications</h3>
        </div>
        <div class="notification-list" id="notificationList">
            <!-- Notifications will be loaded here -->
        </div>
    </div>

    <script>
        // Sample data storage
        let applications = [];
        let notifications = [];
        let currentApplication = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadApplications();
            updateStats();
            setupWebSocket();
        });

        // WebSocket connection for real-time updates
        function setupWebSocket() {
            // Simulated WebSocket - in production, connect to actual WebSocket server
            setInterval(checkForNewApplications, 5000);
        }

        // Check for new applications (simulated)
        function checkForNewApplications() {
            const stored = localStorage.getItem('pendingApplications');
            if (stored) {
                const newApps = JSON.parse(stored);
                newApps.forEach(app => {
                    if (!applications.find(a => a.id === app.id)) {
                        applications.unshift(app);
                        addNotification(`New ${app.type} application from ${app.name}`);
                    }
                });
                loadApplications();
                updateStats();
            }
        }

        // Load applications
        function loadApplications() {
            const tbody = document.getElementById('applicationsTableBody');
            const filtered = filterApplications();
            
            tbody.innerHTML = filtered.map(app => `
                <tr>
                    <td>${app.id}</td>
                    <td>${app.type}</td>
                    <td>${app.name}</td>
                    <td>${app.phone}</td>
                    <td>${app.amount || 'N/A'}</td>
                    <td>${new Date(app.date).toLocaleDateString()}</td>
                    <td><span class="status-badge status-${app.status}">${app.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn btn-view" onclick="viewApplication('${app.id}')">View</button>
                            <button class="action-btn btn-approve" onclick="quickApprove('${app.id}')">âœ“</button>
                            <button class="action-btn btn-reject" onclick="quickReject('${app.id}')">âœ—</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Filter applications
        function filterApplications() {
            let filtered = [...applications];
            
            const typeFilter = document.getElementById('typeFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
            const dateFilter = document.getElementById('dateFilter').value;
            
            if (typeFilter !== 'all') {
                filtered = filtered.filter(app => app.type === typeFilter);
            }
            
            if (statusFilter !== 'all') {
                filtered = filtered.filter(app => app.status === statusFilter);
            }
            
            if (searchFilter) {
                filtered = filtered.filter(app => 
                    app.name.toLowerCase().includes(searchFilter) ||
                    app.id.includes(searchFilter)
                );
            }
            
            if (dateFilter) {
                filtered = filtered.filter(app => 
                    new Date(app.date).toDateString() === new Date(dateFilter).toDateString()
                );
            }
            
            return filtered;
        }

        // Apply filters
        function applyFilters() {
            loadApplications();
        }

        // View application details
        function viewApplication(id) {
            currentApplication = applications.find(app => app.id === id);
            if (currentApplication) {
                const modal = document.getElementById('detailsModal');
                const modalBody = document.getElementById('modalBody');
                
                modalBody.innerHTML = `
                    <div class="detail-row">
                        <span class="detail-label">Application ID:</span>
                        <span class="detail-value">${currentApplication.id}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Type:</span>
                        <span class="detail-value">${currentApplication.type}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Name:</span>
                        <span class="detail-value">${currentApplication.name}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Father's Name:</span>
                        <span class="detail-value">${currentApplication.fatherName}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Mother's Name:</span>
                        <span class="detail-value">${currentApplication.motherName}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Phone:</span>
                        <span class="detail-value">${currentApplication.phone}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">NID:</span>
                        <span class="detail-value">${currentApplication.nid}</span>
                    </div>
                    ${currentApplication.guarantorName ? `
                        <div class="detail-row">
                            <span class="detail-label">Guarantor:</span>
                            <span class="detail-value">${currentApplication.guarantorName}</span>
                        </div>
                    ` : ''}
                    ${currentApplication.amount ? `
                        <div class="detail-row">
                            <span class="detail-label">Amount:</span>
                            <span class="detail-value">${currentApplication.amount}</span>
                        </div>
                    ` : ''}
                    ${currentApplication.duration ? `
                        <div class="detail-row">
                            <span class="detail-label">Duration:</span>
                            <span class="detail-value">${currentApplication.duration}</span>
                        </div>
                    ` : ''}
                    <div class="detail-row">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value"><span class="status-badge status-${currentApplication.status}">${currentApplication.status}</span></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Applied Date:</span>
                        <span class="detail-value">${new Date(currentApplication.date).toLocaleString()}</span>
                    </div>
                `;
                
                modal.style.display = 'flex';
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('detailsModal').style.display = 'none';
        }

        // Update application status
        function updateStatus(status) {
            if (currentApplication) {
                currentApplication.status = status;
                saveToDatabase();
                loadApplications();
                updateStats();
                closeModal();
                addNotification(`Application ${currentApplication.id} marked as ${status}`);
            }
        }

        // Quick approve
        function quickApprove(id) {
            const app = applications.find(a => a.id === id);
            if (app) {
                app.status = 'approved';
                saveToDatabase();
                loadApplications();
                updateStats();
                addNotification(`Application ${id} approved`);
            }
        }

        // Quick reject
        function quickReject(id) {
            const app = applications.find(a => a.id === id);
            if (app) {
                app.status = 'rejected';
                saveToDatabase();
                loadApplications();
                updateStats();
                addNotification(`Application ${id} rejected`);
            }
        }

        // Update statistics
        function updateStats() {
            document.getElementById('totalApplications').textContent = applications.length;
            document.getElementById('pendingApplications').textContent = applications.filter(a => a.status === 'pending').length;
            document.getElementById('approvedApplications').textContent = applications.filter(a => a.status === 'approved').length;
            document.getElementById('rejectedApplications').textContent = applications.filter(a => a.status === 'rejected').length;
        }

        // Add notification
        function addNotification(message) {
            notifications.unshift({
                message,
                time: new Date(),
                read: false
            });
            
            updateNotificationCount();
            updateNotificationList();
        }

        // Update notification count
        function updateNotificationCount() {
            const unreadCount = notifications.filter(n => !n.read).length;
            document.getElementById('notificationCount').textContent = unreadCount;
        }

        // Toggle notifications panel
        function toggleNotifications() {
            const panel = document.getElementById('notificationPanel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
            
            // Mark all as read
            notifications.forEach(n => n.read = true);
            updateNotificationCount();
        }

        // Update notification list
        function updateNotificationList() {
            const list = document.getElementById('notificationList');
            list.innerHTML = notifications.slice(0, 10).map(notif => `
                <div class="notification-item">
                    <div>${notif.message}</div>
                    <div class="notification-time">${formatTime(notif.time)}</div>
                </div>
            `).join('');
        }

        // Format time
        function formatTime(date) {
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);
            
            if (diff < 60) return 'Just now';
            if (diff < 3600) return `${Math.floor(diff / 60)} minutes ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)} hours ago`;
            return date.toLocaleDateString();
        }

        // Export data to CSV
        function exportData() {
            const filtered = filterApplications();
            let csv = 'ID,Type,Name,Phone,Amount,Date,Status\n';
            
            filtered.forEach(app => {
                csv += `${app.id},${app.type},${app.name},${app.phone},${app.amount || 'N/A'},${app.date},${app.status}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'applications_export.csv';
            a.click();
        }

        // Save to database (simulated with localStorage)
        function saveToDatabase() {
            localStorage.setItem('allApplications', JSON.stringify(applications));
        }

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = 'login.html';
            }
        }

        // Sample initial data
        applications = [
            {
                id: 'APP001',
                type: 'islamic-loan',
                name: 'Ahmed Rahman',
                fatherName: 'Rahman Ali',
                motherName: 'Fatima Rahman',
                phone: '+880 1712345678',
                nid: '1234567890123',
                guarantorName: 'Karim Sheikh',
                guarantorNid: '9876543210987',
                amount: '50000',
                duration: '12 months',
                status: 'pending',
                date: new Date().toISOString()
            },
            {
                id: 'APP002',
                type: 'insurance',
                name: 'Salma Khatun',
                fatherName: 'Abdul Khatun',
                motherName: 'Rashida Khatun',
                phone: '+880 1798765432',
                nid: '2345678901234',
                nomineeName: 'Hassan Khatun',
                nomineeNid: '8765432109876',
                amount: '100000',
                duration: '10 years',
                paymentFrequency: 'monthly',
                status: 'reviewing',
                date: new Date(Date.now() - 86400000).toISOString()
            }
        ];

        // Initialize
        loadApplications();
        updateStats();
    </script>
</body>
</html>